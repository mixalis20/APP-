<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload & Annotation</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>Upload Image and Add Annotation</h1>

    <input type="file" id="upload">
    <input type="text" id="objectTitle" placeholder="Enter title">
    <textarea id="objectComment" placeholder="Enter description"></textarea>
    <button id="saveButton">Save Image with Annotation</button>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let image = new Image();
        let isDrawing = false;
        let startX = 0, startY = 0, endX = 0, endY = 0;
        let annotations = [];

        // Load the image into the canvas
        document.getElementById('upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    image.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // On image load, draw it on the canvas
        image.onload = function () {
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
            drawAnnotations();
        };

        // Start drawing annotation
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const pos = getMousePos(e);
            startX = pos.x;
            startY = pos.y;
        });

        // Draw rectangle preview while dragging
        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                const pos = getMousePos(e);
                endX = pos.x;
                endY = pos.y;
                drawRectPreview(startX, startY, endX, endY);
            }
        });

        // End drawing annotation
        canvas.addEventListener('mouseup', () => {
            if (!isDrawing) return;
            isDrawing = false;

            const title = document.getElementById('objectTitle').value.trim() || "Untitled";
            const description = document.getElementById('objectComment').value.trim() || "No description";

            const newAnnotation = {
                x: Math.min(startX, endX),
                y: Math.min(startY, endY),
                width: Math.abs(endX - startX),
                height: Math.abs(endY - startY),
                title: title,
                description: description
            };
            annotations.push(newAnnotation);

            drawAnnotations();
        });

        // Draw the annotations on the canvas
        function drawAnnotations() {
            annotations.forEach(annotation => {
                ctx.beginPath();
                ctx.rect(annotation.x, annotation.y, annotation.width, annotation.height);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'blue';
                ctx.stroke();

                ctx.fillStyle = 'blue';
                ctx.font = '12px Arial';
                ctx.fillText(annotation.title, annotation.x, annotation.y > 10 ? annotation.y - 5 : 10);

                ctx.fillStyle = 'green';
                ctx.font = '10px Arial';
                ctx.fillText(`Description: ${annotation.description}`, annotation.x, annotation.y + annotation.height + 15);
            });
        }

        // Preview rectangle while dragging
        function drawRectPreview(x, y, x2, y2) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0);
            drawAnnotations();

            const rectX = Math.min(x, x2);
            const rectY = Math.min(y, y2);
            const rectWidth = Math.abs(x2 - x);
            const rectHeight = Math.abs(y2 - y);

            ctx.beginPath();
            ctx.rect(rectX, rectY, rectWidth, rectHeight);
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'red';
            ctx.stroke();
        }

        // Save the image and annotation data
        document.getElementById('saveButton').addEventListener('click', async function() {
            const imageFile = document.getElementById('upload').files[0];
            const objectTitle = document.getElementById('objectTitle').value;
            const objectComment = document.getElementById('objectComment').value;

            if (!imageFile) {
                alert('Please upload an image first!');
                return;
            }

            const formData = new FormData();
            formData.append('image', imageFile);
            formData.append('title', objectTitle);
            formData.append('description', objectComment);
            formData.append('annotations', JSON.stringify(annotations));

            try {
                const response = await fetch('http://localhost:5000/api/images/create', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Image uploaded successfully:', result);
                    alert('Image uploaded successfully!');
                } else {
                    alert('Failed to upload image.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error uploading image.');
            }
        });

        // Function to get mouse position relative to the canvas
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            return { x: x, y: y };
        }
    </script>
</body>
</html>
